<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="class">

	<!-- 반생성 url 체크 -->
	<select id="selectByUrl" parameterType="String" resultType="int">
		<![CDATA[
			SELECT c.class_url classUrl
			FROM class c
			where c.class_url = #{classUrl}
		]]>

	</select>


	<!--반생성 -->
	<insert id="insert" parameterType="ClassVo">
	<selectKey keyProperty="classNo" order="BEFORE" resultType="int">
		select seq_class_no.nextval from dual
	</selectKey>
	<![CDATA[
		INSERT INTO class
		VALUES (#{classNo}, #{classUrl}, #{className}, #{logoFile}, TO_DATE(#{startDate},'yyyy-mm-dd HH24:mi'), TO_DATE(#{endDate},'yyyy-mm-dd HH24:mi'), #{hidden})
		
		]]>
	</insert>
	
	<!--반생성 한후-->
	<insert id="self" parameterType="map">
	<![CDATA[
		INSERT INTO join_users 
		VALUES (seq_joinUsers_no.nextval, #{classNo}, #{no}, '승인', '선생님', sysdate)
		]]>
	</insert>

	<!-- 전체리스트 가져오기 -->
	<select id="selectList" resultType="ClassVo" parameterType="int">
	    <![CDATA[
			select 
			j.class_no classNo,
			su.count lCount,
			au.count rCount,
			c.class_name className,
			TO_CHAR(c.start_date,'yyyy-mm-dd') startDate,
			TO_CHAR(c.end_date,'yyyy-mm-dd') endDate,
			c.hidden hidden
			from users u, join_users j , class c,(select
			                                c.class_no,
			                                count(*) count
			                            from class c, join_users j
			                            where c.class_no = j.class_no
			                            and j.approval = '승인'
			                            group by c.class_no
			                            )su,(select
			                                    c.class_no,
			                                    count(*) count 
			                                from class c, join_users j
			                                where c.class_no = j.class_no
			                                and (j.approval = '승인'or j.approval = '대기')
			                                group by c.class_no
			                                )au
			where u.no = j.user_no and u.no='5'
			and j.class_no = su.class_no
			and j.class_no = au.class_no
			and j.class_no = c.class_no
			and j.type = '선생님'
	    ]]>
	</select>



</mapper>
