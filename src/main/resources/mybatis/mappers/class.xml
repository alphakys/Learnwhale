<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="class">

	<!-- 반생성 url 체크 -->
	<select id="selectByUrl" parameterType="String" resultType="int">
		<![CDATA[
			SELECT class_url classUrl
			FROM class
			where class_url = #{classUrl}
		]]>

	</select>


	<!--반생성 -->
	<insert id="insert" parameterType="ClassVo">
	<selectKey keyProperty="classNo" order="BEFORE" resultType="int">
		select seq_class_no.nextval from dual
	</selectKey>
	<![CDATA[
		INSERT INTO class
		VALUES (#{classNo}, #{classUrl}, #{className}, #{logoFile,jdbcType=VARCHAR}, TO_DATE(#{startDate},'yyyy-mm-dd HH24:mi'), TO_DATE(#{endDate},'yyyy-mm-dd HH24:mi'), #{hidden})
		
		]]>
	</insert>
	
	<!--반생성 한후-->
	<insert id="tSelf" parameterType="map">
	<![CDATA[
		INSERT INTO join_users 
		VALUES (seq_joinUsers_no.nextval, #{classNo}, #{no}, '승인', '선생님', sysdate)
		]]>
	</insert>

	<!-- 전체리스트 가져오기 -->
	<select id="selectList" resultType="ClassVo" parameterType="int">
	    <![CDATA[
			select cl.class_no classNo,
			       cl.class_name className,
			       nvl2(total, total, 0) total,
			       nvl2(approval, approval, 0) approval,
			       TO_CHAR(cl.start_date,'yyyy-mm-dd') startDate,
			       TO_CHAR(cl.end_date,'yyyy-mm-dd') endDate,
			       cl.class_url classUrl,
			       cl.hidden hidden,
			       CASE WHEN cl.start_date <= sysdate and sysdate <= cl.end_date THEN '진행중'
			            WHEN sysdate < cl.start_date THEN '대기'
			            ELSE '종료'
			       END AS state
			from class cl left outer join (select      j.class_no,
			                                            count(j.class_no) total,
			                                            count(case when type='학생' and approval = '승인' then 1 end) approval
			                                from join_users j, (select class_no
			                                                    from   join_users
			                                                    where  user_no = #{no}) c
			                                where type='학생' and (approval = '대기' or approval='승인')
			                                and c.class_no = j.class_no
			                                group by j.class_no
			                                ) co
			on cl.class_no = co.class_no
		]]>
			<if test="search != null and search !='' ">
				where cl.class_name like '%' || #{search} || '%'
			</if>	
		<![CDATA[
			
			order by cl.class_no desc
	   	]]>
	</select>
	
	<!-- 수정폼 -->
	<select id = "selectOne" parameterType="int" resultType="classVo">
		<![CDATA[
			SELECT  class_url classUrl,
			        class_name className,
			        TO_CHAR(start_date,'yyyy-mm-dd HH24:mi') startDate,
			        TO_CHAR(end_date,'yyyy-mm-dd HH24:mi') endDate,
			        logo_file logoFile,
			        hidden hidden
			FROM class c, join_users j, users u
			where c.class_no = j.class_no
			and u.no = j.user_no
			and c.class_no = #{classNo}
			and j.type= '선생님'
		]]>
	</select>
	
	<!-- 수정 -->
	<select id ="update" parameterType="classVo" resultType="classVo">
		<![CDATA[
			UPDATE class
			SET class_name = #{className},
			    logo_file = #{logoFile,jdbcType=VARCHAR},
			    start_date = TO_DATE(#{startDate},'yyyy-mm-dd HH24:mi'),
			    end_date = TO_DATE(#{endDate},'yyyy-mm-dd HH24:mi'),
			    hidden = #{hidden}
			where class_no = #{classNo}
		]]>
	</select>
	
	<!-- join삭제 -->
	<select id="joindelete" parameterType="int">
		<![CDATA[
			delete join_users
			where class_no = {classNo}
			and type = '선생님'
		]]>
	</select>
	
	<!-- class삭제 -->
	<select id="joindelete" parameterType="int">
		<![CDATA[
			delete join_users
			where class_no = {classNo}
			and type = '선생님'
		]]>
	</select>
</mapper>
